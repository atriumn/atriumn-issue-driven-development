name: Atriumn Reusable Pipeline

on:
  workflow_call:
    inputs:
      repo_name:
        required: true
        type: string
      issue_number:
        required: true
        type: string
      feature_ref:
        required: true
        type: string
      action:
        required: true
        type: string   # "run" or "approve"
      phase:
        required: true
        type: string   # "research" | "plan" | "implement" | "validate"
      task_description:
        required: false
        type: string
      trigger_comment:
        required: false
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: read
  id-token: write

jobs:
  run-phase:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout consumer repo
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repo_name }}
          ref: ${{ inputs.feature_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Ensure feature branch exists (create if missing)
        shell: bash
        run: |
          set -euo pipefail
          BR="${{ inputs.feature_ref }}"
          if ! git rev-parse --verify --quiet "$BR"; then
            git fetch origin "${BR}" || true
            if ! git rev-parse --verify --quiet "origin/${BR}"; then
              # create from default branch
              DEFAULT_BRANCH="$(git remote show origin | sed -n '/HEAD branch/s/.*: //p')"
              git checkout -b "$BR" "origin/${DEFAULT_BRANCH}"
            else
              git checkout -b "$BR" "origin/${BR}"
            fi
          else
            git checkout "$BR"
          fi
          git status

      - name: Ensure output directories exist
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p thoughts/shared/research
          mkdir -p thoughts/shared/research/tmp
          mkdir -p thoughts/shared/decisions
          mkdir -p thoughts/shared/plans

      - name: Checkout shared repo (to load task-packs)
        uses: actions/checkout@v4
        with:
          repository: atriumn/atriumn-issue-driven-development
          ref: main
          path: _shared

      - name: Load task-pack prompt for phase
        id: load_prompt
        uses: actions/github-script@v7
        env:
          PHASE: ${{ inputs.phase }}
          ACTION: ${{ inputs.action }}
        with:
          script: |
            const fs = require('fs');
            const phase = process.env.PHASE;
            const action = process.env.ACTION;
            
            if (!phase) {
              core.setFailed('Phase input is required');
              return;
            }
            
            // For run actions, load the task-pack
            if (action !== 'run') {
              core.setFailed('Only run actions need task-pack prompts');
              return;
            }
            const promptPath = `_shared/.atriumn/task-packs/${phase}.md`;
            if (!fs.existsSync(promptPath)) {
              core.setFailed(`Missing task-pack prompt: ${promptPath}`);
              return;
            }
            const prompt = fs.readFileSync(promptPath, 'utf8');
            core.setOutput('prompt', prompt);

          result-encoding: string


      - name: Run Claude Code (single-session, direct prompt)
        if: ${{ inputs.action == 'run' }}
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          
          # Higher timeout for research tasks
          timeout_minutes: 40
          
          allowed_tools: |
            Read
            Write
            Edit
            MultiEdit
            Grep
            Glob
            LS
            TodoWrite

          # Allow App/bot actors in case a maintainer runs this via re-runs, etc.
          allowed_bots: "*"

          # Pass a fully-rendered prompt to Claude
          direct_prompt: |
            ${{ steps.load_prompt.outputs.prompt }}

            ---
            # Context variables (for the prompt to interpolate):
            feature_ref = "${{ inputs.feature_ref }}"
            issue_number = "${{ inputs.issue_number }}"
            repository = "${{ inputs.repo_name }}"
            task_description = "${{ inputs.task_description }}"
            output_path = "thoughts/shared/research/issue-${{ inputs.issue_number }}.md"
            decision_record_path = "thoughts/shared/decisions/issue-${{ inputs.issue_number }}.md"
            phase = "${{ inputs.phase }}"
            action = "${{ inputs.action }}"
            trigger_comment = "${{ inputs.trigger_comment }}"

      - name: Assert research artifacts exist (research phase only)
        if: ${{ inputs.phase == 'research' }}
        shell: bash
        run: |
          set -euo pipefail
          test -s "thoughts/shared/research/issue-${{ inputs.issue_number }}.md" \
            || (echo "Expected research output missing or empty" && exit 1)
          test -s "thoughts/shared/decisions/issue-${{ inputs.issue_number }}.md" \
            || (echo "Expected decision record missing or empty" && exit 1)

      - name: Stash generated files from Claude branch
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$RUNNER_TEMP/atriumn_out"
          # copy only what we want to commit
          rsync -a --delete thoughts/shared/ "$RUNNER_TEMP/atriumn_out/shared/"

      - name: Switch to target feature branch
        shell: bash
        run: |
          set -euo pipefail
          TARGET="${{ inputs.feature_ref }}"
          git fetch origin "$TARGET" || true
          # create or reset local branch to remote if it exists; otherwise start new
          if git show-ref --verify --quiet "refs/remotes/origin/$TARGET"; then
            git checkout -B "$TARGET" "origin/$TARGET"
          else
            git checkout -B "$TARGET"
          fi

      - name: Restore generated files onto target branch
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p thoughts/shared
          rsync -a "$RUNNER_TEMP/atriumn_out/shared/" "thoughts/shared/"

      - name: Ignore _shared working dir
        shell: bash
        run: |
          echo "/_shared" >> .git/info/exclude

      - name: Ensure _shared/ is not staged
        shell: bash
        run: |
          git restore --staged _shared || true

      - name: Commit & push artifacts to target branch
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "atriumn-bot"
          git config user.email "bot@atriumn.dev"
          # only add the thoughts directory (avoid picking up anything else)
          git add thoughts/
          if ! git diff --cached --quiet; then
            git commit -m "Atriumn ${{ inputs.phase }} artifacts for issue #${{ inputs.issue_number }}"
            git push origin "${{ inputs.feature_ref }}"
          else
            echo "No changes to commit."
          fi

      - name: Post completion comment with file links
        if: ${{ inputs.phase == 'research' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = '${{ inputs.issue_number }}';
            const featureRef = '${{ inputs.feature_ref }}';
            const phase = '${{ inputs.phase }}';
            
            const researchUrl = `https://github.com/${owner}/${repo}/blob/${featureRef}/thoughts/shared/research/issue-${issueNumber}.md`;
            const decisionUrl = `https://github.com/${owner}/${repo}/blob/${featureRef}/thoughts/shared/decisions/issue-${issueNumber}.md`;
            
            const body = `âœ… **${phase.charAt(0).toUpperCase() + phase.slice(1)} completed**

ðŸ“‹ **Generated Files:**
- [Research Document](${researchUrl})
- [Decision Record](${decisionUrl})

ðŸŒ¿ **Branch:** [\`${featureRef}\`](https://github.com/${owner}/${repo}/tree/${featureRef})`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: parseInt(issueNumber),
              body
            });

      - name: Legacy commit step (unused but kept for compatibility)
        if: always()
        shell: bash
        run: |
          set -e
          git config user.name  "atriumn-bot"
          git config user.email "bot@atriumn.dev"
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "Atriumn ${{
              inputs.phase
            }} artifacts for issue #${{ inputs.issue_number }}"
            git push origin "${{ inputs.feature_ref }}"
          else
            echo "No changes to commit."
          fi