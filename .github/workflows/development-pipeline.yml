name: Development Pipeline (Simple)

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode'
        required: false
        type: boolean
        default: true

jobs:
  validate-workflow:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout shared workflows
        uses: actions/checkout@v4
        
      - name: Install dependencies
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          sudo apt-get update && sudo apt-get install -y gh
          
      - name: Test validation scripts
        run: |
          echo "ğŸ§ª Testing validation scripts..."
          
          # Test that scripts are executable
          for script in scripts/*.sh; do
            if [ -x "$script" ]; then
              echo "âœ… $script is executable"
            else
              echo "âŒ $script is not executable"
              exit 1
            fi
          done
          
          # Test help output
          for script in scripts/validate-*.sh; do
            if "$script" --help | grep -q "Usage:"; then
              echo "âœ… $script has help output"
            else
              echo "âŒ $script missing help output"
              exit 1
            fi
          done
          
      - name: Test configuration loading
        run: |
          echo "ğŸ“‹ Testing configuration files..."
          
          # Test YAML syntax
          for config in configs/*.yml; do
            if yq eval '.' "$config" > /dev/null; then
              echo "âœ… $config has valid YAML syntax"
            else
              echo "âŒ $config has invalid YAML syntax"
              exit 1
            fi
          done
          
      - name: Run test suite
        run: |
          echo "ğŸ”¬ Running validation script tests..."
          
          # Debug: Test plan validation directly first
          echo "ğŸ› Debug: Testing plan validation directly..."
          mkdir -p test/test-data
          cat > test/test-data/debug-plan.md << 'EOF'
          ---
          date: 2025-08-17T14:30:00-05:00
          researcher: test-user
          topic: "Debug Plan"
          status: complete
          ---
          
          # Implementation Plan: Debug
          
          ## Implementation Approach
          Debug approach.
          
          ## Phase 1: Test
          Test phase.
          
          #### Automated Verification:
          - `make test` - Run tests
          
          #### Manual Verification:
          - Manual test
          EOF
          
          echo "ğŸ” Running plan validation with debug output..."
          if ./scripts/validate-plan.sh "" test/test-data/debug-plan.md; then
            echo "âœ… Debug plan validation passed"
          else
            echo "âŒ Debug plan validation failed - investigating..."
            echo "ğŸ“‹ Config contents:"
            cat configs/default.yml
            echo "ğŸ“„ Test document contents:"
            cat test/test-data/debug-plan.md
          fi
          
          echo "ğŸ”¬ Running full test suite..."
          ./test/test-validation-scripts.sh all
          
      - name: Workflow validation complete
        run: |
          echo "âœ… All workflow validations passed!"
          echo "ğŸ“¦ Repository is ready for pipeline deployment"